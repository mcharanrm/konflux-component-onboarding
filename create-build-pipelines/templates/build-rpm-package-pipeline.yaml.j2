---
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  annotations:
    build.appstudio.openshift.io/repo: {{'"{{repo_url}}'}}?rev={{'{{revision}}"'}}
    build.appstudio.redhat.com/commit_sha: {{"'{{revision}}'"}}
    build.appstudio.redhat.com/pull_request_number: {{"'{{pull_request_number}}'"}}
    build.appstudio.redhat.com/target_branch: {{"'{{target_branch}}'"}}
    pipelinesascode.tekton.dev/cancel-in-progress: "true"
    pipelinesascode.tekton.dev/max-keep-runs: "3"
    pipelinesascode.tekton.dev/on-cel-expression: event == "pull_request" && target_branch == "master"
  creationTimestamp: null
  labels:
    appstudio.openshift.io/application: "{{ kflux_data.knflux_app_name }}"
    appstudio.openshift.io/component: "{{ kflux_data.knflux_comp_name }}"
    pipelines.appstudio.openshift.io/type: build
  name: "{{ kflux_data.knflux_comp_name }}-on-pull-request"
  namespace: "{{ kflux_data.knflux_tenant_name }}"
spec:
  params:
    - name: package-name
      value: libecpg
    - name: git-url
      value: {{'"{{ source_url }}"'}}
    - name: revision
      value: {{'"{{ revision }}"'}}
    - name: target-branch
      value: "main"
    {% if not (build_multi_arch | bool) -%}
    - name: build-architectures
      value: [ x86_64 ]
    {% endif -%}
    - name: ociStorage
      value: quay.io/{{ gh_api.kflux_gh_app.installation.quay_org }}/{{ kflux_data.knflux_tenant_name }}/{{ kflux_data.knflux_comp_name }}:on-pr-{{'{{revision}}'}}
  pipelineRef:
    resolver: git
    params:
      - name: url
        value: https://gitlab.com/fedora/infrastructure/konflux/rpmbuild-pipeline.git
      - name: revision
        value: "main"
      - name: pathInRepo
        value: pipeline/build-rpm-package.yaml
  workspaces:
    - name: git-auth
      secret:
        secretName: {{"'{{ git_auth_secret }}'"}}
  taskRunTemplate:
    serviceAccountName: build-pipeline-{{ kflux_data.knflux_comp_name }}
